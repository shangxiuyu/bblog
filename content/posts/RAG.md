---
title: "RAG"
date: 2024-03-13
draft: false
tags: ["AI", "RAG"]
---

向 AI 询问有关您个人文档的问题，却收到完全杜撰的答案？这些都是传统 LLM（大型语言模型）的常见问题，但有一个解决方案：检索增强生成 (RAG) 

现在很多AI客户端产品支持联网搜索，也是利用了RAG的技术

## RAG是什么？

RAG：检索增强生成

想象一下，RAG 就像给 AI 配备了专属的私人研究管理员，让它先回答你的问题

- 文档收集：您向系统提供您的文档（公司手册、文章、书籍），就像将书籍添加到图书馆一样。

- 分块：系统将这些内容分解成易于理解的小块：就像图书管理员将书籍分成章节和部分而不是处理整卷一样。

- 嵌入：每个块都被转换成一种特殊的数字格式（向量），以捕捉其含义：类似于创建理解概念而不仅仅是关键字的详细索引卡。

- 索引：这些向量被组织在一个可搜索的数据库中：就像一个了解不同主题之间关系的神奇卡片目录。

- 检索：当您提出问题时，系统会查阅其索引以找到与您的查询最相关的块。

- 生成：人工智能会根据您的问题和这些有用的参考资料来制作答案，从而产生比仅仅依赖预先训练的知识更好的答案。


## 分块：将文档分解成可管理的部分

为了让 RAG 系统有效运作，我们需要将文档分解成更小、更易消化的部分。把分块想象成为客人准备一顿饭——你不会不先切开火鸡就端上桌！

为什么组块很重要？

块的大小直接影响 RAG 系统的质量：

块太大：您的系统检索了太多不相关的信息（例如提供整只火鸡）

块太小：你会丢失重要的内容（例如提供单个豌豆）

恰到好处的块：您的系统准确地找到它所需要的（完美的部分！）

让我们探索一些实用的分块方法：

1. 固定大小分块：简单但不完美
最简单的方法是将文本分成大小相等的部分，而不管内容如何：


2.基于句子的分块：尊重自然边界
更聪明的方法是按完整的句子进行分块：

该方法首先识别完整的句子，然后逐个对它们进行分组：

输出块：


好多了！现在每个块都包含一个完整的句子，其含义完整无缺。

3. 额外的分块策略
根据您的文档，这些方法可能也会很有效：

基于段落：在段落分隔符处拆分文本（通常以换行符标记）

语义分块：按主题或含义对文本进行分组（通常需要人工智能辅助）

混合方法：结合多种策略以获得最佳结果

选择正确的方法
虽然存在许多复杂的分块方法，但对于大多数实际应用而言，“保持简单，简洁”（KISS）原则仍然适用。通常情况下，从每个分块约 1,000 个字符的固定大小分块开始就足够了，并且可以避免系统过于复杂。

最好的分块方法最终取决于您的具体文档和用例 - 就像厨师根据饭菜和客人调整份量一样！

嵌入：使检索成为可能
现在我们已经将文档切分好了，系统如何找到与我们的问题最相关的部分呢？这时嵌入就派上用场了！嵌入是驱动我们检索系统的魔力所在。没有它们，我们就无法找到与我们的问题相关的正确信息！


## 什么是嵌入？

嵌入将文本转换为一个数字列表（向量），以捕捉其含义。可以将其视为在意义空间中创建一个特殊的“位置”，将相似的想法紧密地放在一起。

例如，如果我们看这三个句子：

“猫坐在垫子上。”🐱

“一只猫在地板上休息。”🐈

“Python 是一种流行的编程语言。”💻

好的嵌入系统会将句子 1 和句子 2 放在一起（因为它们描述相同的概念），而句子 3 则放在很远的地方（完全不同的主题）。

可视化嵌入的实际应用
当我们将这些句子转换为嵌入时，我们可能会在简化的二维空间中得到类似这样的内容：

Sentence 1 (🐱): [0.8, 0.2]
Sentence 2 (🐈): [0.7, 0.3] 
Sentence 3 (💻): [-0.5, -0.9]
在图表上，与猫相关的句子会聚集在右上方，而编程句子会位于左下方——直观地显示它们的语义关系！


通过嵌入，测量相似性就像计算点之间的距离一样简单：

🐱 到 🐈 的距离：非常小（约 0.14 个单位）→ 非常相似！

🐱 到 💻 的距离：非常大（约 1.95 个单位）→ 完全不相关！

这证实了我们直观地知道的——猫的句子是密切相关的，而编程的句子则完全不同。

创建嵌入：从简单到高级
1. 简单方法：字符频率


局限性：这种简单的方法无法识别“猫”和“猫科动物”是相关概念，因为它们没有共同的特征！

2. 专业方法：人工智能驱动的嵌入
在真正的 RAG 系统中，您将使用像 OpenAI 的嵌入 API 这样的复杂模型：


这些高级嵌入能够捕捉高维空间（OpenAI 的嵌入通常为 1,536 维）中的深层语义关系。它们能够理解“cat”🐱 和 “feline”🐈 的含义相同，即使它们包含完全不同的字符！


尽管句子 1 和句子 2 使用了不同的词汇，但它们的嵌入却具有相似的模式，因为它们表达了相似的概念。与此同时，句子 3 的嵌入则具有完全不同的模式，因为它涉及完全不同的主题。

嵌入如何驱动我们的 RAG 系统
在我们的 RAG 管道中：

我们嵌入所有文档块并存储这些向量

当用户提出问题时，我们也会嵌入该问题

我们找到嵌入与问题嵌入最接近的文档块

然而，随着文档集增长到数千甚至数百万个块，搜索所有嵌入会变得缓慢。这时，矢量数据库就派上用场了——它是一种专门设计的系统，旨在让搜索速度飞快！


## 矢量数据库：快速检索

想象一下，为了找到答案，不得不翻阅一百万页书——这需要永远的时间！矢量数据库通过巧妙地组织嵌入来解决这个问题，使搜索速度变得闪电般快。

为什么我们需要矢量数据库
当你提出一个问题时，你的 RAG 系统需要将其与可能成千上万个文档块进行比较。有两种方法可以做到这一点：

1. 简单方法：穷举搜索
在这种方法中，我们逐一检查每个文档块 - 就像检查图书馆中的每一页一样：

这对于几十个文档来说非常有效，但对于数千或数百万个块来说，速度会变得非常慢。

2. 专业方法：使用矢量数据库进行智能索引
矢量数据库就像有一位神奇的图书管理员，他可以非常有效地组织书籍，无需检查每个书架就可以立即找到您需要的内容。

让我们通过两个简单的步骤来了解它的工作原理：

第一步：构建魔法指数
首先，我们将所有文档嵌入组织成一个特殊的结构：

这就像创建一张详细的地图，标明每个文档在我们的意义空间中“存在”的位置。

步骤2：使用索引快速检索
当问题出现时，我们使用神奇的索引立即找到最相关的块：


索引不需要检查每个文档，而是确切地知道在哪里查找 - 在几毫秒内为我们提供最相关的前 5 个块！

什么使得矢量数据库如此高效？
矢量数据库的速度来自于三个巧妙的技术：

智能索引算法：HNSW （分层可导航小世界）等方法通过嵌入空间创建快捷方式，因此系统只需要检查一小部分文档。

矢量压缩：这些数据库可以缩小嵌入以节省内存，同时保留它们的关系 - 就像拥有一张仍然显示所有重要地标的压缩地图一样。

并行处理：现代矢量数据库同时使用多个 CPU/GPU 核心，一次检查多种可能性 - 就像让一组图书管理员同时搜索图书馆的不同部分一样。

利用这些技术，矢量数据库可以在几毫秒内搜索数百万个文档 - 使得 RAG 系统即使对于最大的文档集合也实用！

将 RAG 放在一起：仅需两个简单的工作流程
现在您已经了解了分块、嵌入和向量数据库，下面是 RAG 的简洁之美，而许多框架却将其复杂化：

RAG 只是两个简单的工作流程协同工作！

可以将 RAG 视为您的个人研究助理，它分为两个高效的流程：


1. 离线流程：准备你的知识库
在提出任何问题之前，这种情况只发生一次：

分块：将文档分成小块（就像将一本书分成几个容易记住的段落一样）

嵌入：将每个块转换为数字向量（就像赋予每个段落在意义空间中唯一的“位置”）

索引：组织这些向量以实现有效检索（就像创建一张包含所有知识的神奇地图）

2. 在线流程：实时回答问题
每次有人问问题时都会发生这种情况：

查询嵌入：将问题转换为向量（在相同的意义空间中找到它的“位置”）

检索：找到最接近问题的文档块（找到最相关的知识）

增强生成：使用问题和检索到的上下文创建答案（根据您的特定文档制定答案）

就是这样！RAG 的神奇之处不在于复杂的算法，而在于这两个简单的工作流程如何协同工作，根据您的特定知识提供准确、相关的答案

推荐阅读：https://zacharyhuang.substack.com/p/retrieval-augmented-generation-rag
 
